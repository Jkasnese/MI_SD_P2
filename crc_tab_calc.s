.data

# Alocating space to crc lookup table
table: .word 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF

.text

# Reads byte from RS232 and stores it into r10
__read_byte:

wait_data:
ldb r16, 0x0(r18)
bgt r16, r0, read
br wait_data

read:
ldbu r10, 0x0(r15) # Reads byte
movia r11, 0x1 
stb r11, 0x0(r18) r18 # Signals that byte was read.
stb r0, 0x0(r18) # If there is no new data, it means you read the last data and the fpga already knows.
ret

.global main 

main:

# Algorithm Configurations
movia r1, 0x100 # Table size in words = 2^8.
movui r4, 0x8 # Number of divisions or number of bits operated together on CRC algorithm 
movia r17, table # initial table position
# Initializing r9 to hold the poly
movui r9, 0x04C1
slli r9, r9, 0x10
ori r9, r9, 0x1DB7

# RS232 config
movia r15, 0x30f0 # Memory location of the new byte
movia r18, 0x30c0 # Memory location of the data read sign.

# TABLE CALCULATION
mov r7, r17 # r7 gets permanent table position to iterate upon

movui r2, 0x0 # i=0. Will be incremented until table size.


# Table's FOR

next_number:
  bgeu r2, r1, begin_transmission # If i >= 256, table is over. Go to algorithm

mov r3, r2 # r3 == rem, rem=i

slli r3, r3, 0x18 # Makes it the top byto to be shifted left

movui r5, 0x0 # j = 0

# XOR's FOR

next_div:
  bge r5, r4, store_number # If already checked all the bits, store number.
  
andhi r6, r3, 0x8000 # compare msb
slli r3, r3, 0x1
beq r0, r6, dont_xor
xor r3, r3, r9
dont_xor:
  addi r5, r5, 0x1
br next_div

store_number:
  stw r3, 0(r7)

addi r2, r2, 0x1
addi r7, r7, 0x4 # Each position is 4 bytes in size (32 bits size)

br next_number

# END XOR FOR

# END TABLE CALCULATION

begin_transmission:

#
#    Registrador de configurações:
#
#    B0 (LSB) - Presença de paridade: (1 sim/ 0 não) - Use parity: (1 yes/ 0 no)
#    B1 - Paridade: (0 par/1impar) - Parity: (0 even, 1 0dd)
#    B2e3 - Dados: (11 5, 10 6, 01 7, 00 8) - Data bits per package
#    B4 - Stopbits: um 0, dois 1 - one 0, two 1
#    B5 - Handshake: (1sim/0não) - 1y/0n
#    B6e7 - Velocidade clock: (0 9600/ 1 19200 / 2 57600 / 3 115200 - Baudrate
#

movia r1, 0xC0 # Initial Configurations of RS232. See table above. 
movia r8, 0x30b0 # Address of RS232 configurations on FPGA
stb r1, 0x0(r8)
call __read_byte # Reads byte with new RS232 configurations
stb r10, 0x0(r8)

# Receive size of the message. First receive most significative byte, then less significative byte.
# Size of message is then stored in r8.
call __read_byte
mov r8, r10
slli r8, r8, 0x8
call __read_byte
or r8, r8, r10

# CRC CALCULATION

#movia r2, 0xFFFFFFFF # initial xor
ori r2, r2, 0xFFFF
slli r2, r2, 0x10
ori r2, r2, 0xFFFF

movi r3, 0x0 # i

crc_loop:
  bge r3, r8, crc2lcd

# byte "leaving" register tru right. To be xored with msg
# gets r2 high byte into r4
andhi r4, r2, 0xFF00

slli r2, r2, 0x8 # removes most significant byte

srli r4, r4, 0x18

call __read_byte # Gets bytes from msg into r10

# r10 holds the last received byte. r22 holds the last received word (crc)
slli r22, r22, 0x8
or r22, r22, r10

xor r4, r4, r10 # xor bytes from msg and reg

slli r4, r4, 0x2 # each table position has 4 bytes, so multiply by 4

add r4, r4, r17 # r17 has first table address. r4 is table offset

ldw r6, 0(r4)

xor r2, r2, r6

addi r3, r3, 0x1 # increment iteration counter

br crc_loop

crc2lcd:
# LCD Config
movia r3, 0x3090 # Second argument is the address of the LCD in the Nios.
movia r5, 0x3080 # Second argument is the address of the CRC Status in the Nios core.
movia r6, 0x3070 # Second argument is the address of the LCD Config in the Nios core.
movia r10, 0x3060 # Reset LCD Address
movia r7, 0x0 # LCD Configuration. LSB = cursor direction (0 left / 1 right). MSB = Number of lines (0 one line / 1 two lines)
stw r7, 0x0(r6)
movia r1, 0x1 # Reset LCD

# r22 contains the received crc. r2 contains the calculated crc.
beq r0, r2, crcok

movia r4, 0x1

br store_crc

crcok:
mov r4, r0

store_crc:
stw r22, 0x0(r3)
stw r4, 0x0(r5)
stw r1, 0x0(r10)
stw r0, 0x0(r10)
br begin_transmission


